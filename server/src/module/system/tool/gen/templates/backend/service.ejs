/**
 * <%= functionName %> 服务
 * @author <%= functionAuthor %>
 * @date <%= datetime %>
 */
import { Injectable } from '@nestjs/common';
import { Prisma, DelFlag } from '@prisma/client';
import { Result } from 'src/common/response';
import { PrismaService } from 'src/prisma/prisma.service';
import { Create<%= BusinessName %>Dto, Update<%= BusinessName %>Dto, Query<%= BusinessName %>Dto } from './dto/<%= businessName %>.dto';
import { isEmpty } from 'src/common/utils';
<% if (options.enableExport || options.enableImport) { -%>
import { Response } from 'express';
import * as ExcelJS from 'exceljs';
<% } -%>
<% if (options.enableTenant) { -%>
import { TenantContext } from 'src/common/context/tenant.context';
<% } -%>

@Injectable()
export class <%= BusinessName %>Service {
  constructor(
    private readonly prisma: PrismaService,
<% if (options.enableTenant) { -%>
    private readonly tenantContext: TenantContext,
<% } -%>
  ) {}

  /**
   * 创建<%= functionName %>
   */
  async create(create<%= BusinessName %>Dto: Create<%= BusinessName %>Dto) {
<% if (options.enableTenant) { -%>
    const tenantId = this.tenantContext.getTenantId();
<% } -%>
    const res = await this.prisma.<%= classNameLower %>.create({
      data: {
        ...create<%= BusinessName %>Dto,
<% if (options.enableTenant) { -%>
        tenantId,
<% } -%>
      },
    });
    return Result.ok(res);
  }

  /**
   * 查询<%= functionName %>列表
   */
  async findAll(query: Query<%= BusinessName %>Dto) {
<% if (listColumns.length > 0) { -%>
    const listSelect: Prisma.<%= className %>Select = {
<% listColumns.forEach(function(col) { -%>
      <%= col.javaField %>: true,
<% }); -%>
    };
<% } -%>
    const where: Prisma.<%= className %>WhereInput = {
      delFlag: DelFlag.NORMAL,
<% if (options.enableTenant) { -%>
      tenantId: this.tenantContext.getTenantId(),
<% } -%>
    };
<% queryColumns.forEach(function(col) { -%>
<% if (col.queryType === 'EQ') { -%>
    if (!isEmpty(query.<%= col.javaField %>)) {
      where.<%= col.javaField %> = query.<%= col.javaField %>;
    }
<% } else if (col.queryType === 'NE') { -%>
    if (!isEmpty(query.<%= col.javaField %>)) {
      where.<%= col.javaField %> = { not: query.<%= col.javaField %> };
    }
<% } else if (col.queryType === 'GT') { -%>
    if (!isEmpty(query.<%= col.javaField %>)) {
      where.<%= col.javaField %> = { gt: query.<%= col.javaField %> };
    }
<% } else if (col.queryType === 'GTE') { -%>
    if (!isEmpty(query.<%= col.javaField %>)) {
      where.<%= col.javaField %> = { gte: query.<%= col.javaField %> };
    }
<% } else if (col.queryType === 'LT') { -%>
    if (!isEmpty(query.<%= col.javaField %>)) {
      where.<%= col.javaField %> = { lt: query.<%= col.javaField %> };
    }
<% } else if (col.queryType === 'LTE') { -%>
    if (!isEmpty(query.<%= col.javaField %>)) {
      where.<%= col.javaField %> = { lte: query.<%= col.javaField %> };
    }
<% } else if (col.queryType === 'LIKE') { -%>
    if (!isEmpty(query.<%= col.javaField %>)) {
      where.<%= col.javaField %> = { contains: query.<%= col.javaField %> };
    }
<% } else if (col.queryType === 'BETWEEN') { -%>
    if (Array.isArray(query.<%= col.javaField %>) && query.<%= col.javaField %>.length === 2) {
      where.<%= col.javaField %> = { gte: query.<%= col.javaField %>[0], lte: query.<%= col.javaField %>[1] };
    }
<% } -%>
<% }); -%>

    const pageSize = Number(query.pageSize ?? 10);
    const pageNum = Number(query.pageNum ?? 1);
    const queryArgs: Prisma.<%= className %>FindManyArgs = {
      where,
      skip: pageSize * (pageNum - 1),
      take: pageSize,
<% if (listColumns.length > 0) { -%>
      select: listSelect,
<% } -%>
    };

    if (query.orderByColumn && query.isAsc) {
      queryArgs.orderBy = {
        [query.orderByColumn]: query.isAsc === 'ascending' ? 'asc' : 'desc',
      } as Prisma.<%= className %>OrderByWithRelationInput;
    }

    const [list, total] = await this.prisma.$transaction([
      this.prisma.<%= classNameLower %>.findMany(queryArgs),
      this.prisma.<%= classNameLower %>.count({ where }),
    ]);

    return Result.ok({
      rows: list,
      total,
    });
  }

  /**
   * 查询<%= functionName %>详情
   */
  async findOne(<%= primaryKey %>: <%= getTsType(pkColumn) %>) {
    const res = await this.prisma.<%= classNameLower %>.findFirst({
      where: {
        delFlag: DelFlag.NORMAL,
        <%= primaryKey %>: <%= primaryKey %>,
<% if (options.enableTenant) { -%>
        tenantId: this.tenantContext.getTenantId(),
<% } -%>
      },
    });
    return Result.ok(res);
  }

  /**
   * 修改<%= functionName %>
   */
  async update(update<%= BusinessName %>Dto: Update<%= BusinessName %>Dto) {
    const res = await this.prisma.<%= classNameLower %>.update({
      where: {
        <%= primaryKey %>: update<%= BusinessName %>Dto.<%= primaryKey %>,
      },
      data: update<%= BusinessName %>Dto,
    });
    return Result.ok({ value: Boolean(res) });
  }

  /**
   * 删除<%= functionName %>
   */
  async remove(<%= primaryKey %>s: <%= getTsType(pkColumn) %>[]) {
    const res = await this.prisma.<%= classNameLower %>.updateMany({
      where: {
        <%= primaryKey %>: {
          in: <%= primaryKey %>s,
        },
<% if (options.enableTenant) { -%>
        tenantId: this.tenantContext.getTenantId(),
<% } -%>
      },
      data: {
        delFlag: '1',
      },
    });
    return Result.ok({ value: res.count >= 1 });
  }
<% if (options.enableExport) { -%>

  /**
   * 导出<%= functionName %>
   */
  async export(query: Query<%= BusinessName %>Dto, res: Response) {
    const { rows } = (await this.findAll({ ...query, pageSize: 10000, pageNum: 1 })).data;
    
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('<%= functionName %>');
    
    // 设置表头
    worksheet.columns = [
<% columns.filter(col => col.isList === '1').forEach(function(col) { -%>
      { header: '<%= col.columnComment %>', key: '<%= col.javaField %>', width: 20 },
<% }); -%>
    ];
    
    // 添加数据
    worksheet.addRows(rows);
    
    // 设置响应头
    res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
    res.setHeader('Content-Disposition', 'attachment; filename=<%= options.exportFileName || businessName %>.xlsx');
    
    await workbook.xlsx.write(res);
    res.end();
  }
<% } -%>
<% if (options.enableImport) { -%>

  /**
   * 导入<%= functionName %>
   */
  async import(file: Express.Multer.File) {
    const workbook = new ExcelJS.Workbook();
    await workbook.xlsx.load(file.buffer);
    
    const worksheet = workbook.getWorksheet(1);
    const rows: any[] = [];
    
    worksheet.eachRow((row, rowNumber) => {
      if (rowNumber === 1) return; // 跳过表头
      
      const data: any = {};
<% columns.filter(col => col.isInsert === '1').forEach(function(col, index) { -%>
      data.<%= col.javaField %> = row.getCell(<%= index + 1 %>).value;
<% }); -%>
      rows.push(data);
    });
    
    // 批量插入
    const result = await this.prisma.<%= classNameLower %>.createMany({
      data: rows,
      skipDuplicates: true,
    });
    
    return Result.ok({ count: result.count });
  }

  /**
   * 下载导入模板
   */
  async importTemplate(res: Response) {
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('<%= functionName %>导入模板');
    
    worksheet.columns = [
<% columns.filter(col => col.isInsert === '1').forEach(function(col) { -%>
      { header: '<%= col.columnComment %>', key: '<%= col.javaField %>', width: 20 },
<% }); -%>
    ];
    
    res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
    res.setHeader('Content-Disposition', 'attachment; filename=<%= businessName %>_template.xlsx');
    
    await workbook.xlsx.write(res);
    res.end();
  }
<% } -%>
}
